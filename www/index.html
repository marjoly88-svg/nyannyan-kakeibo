<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>家計簿</title>
  <link rel="icon" type="image/png" href="icon-192.png">
  <link rel="apple-touch-icon" href="apple-touch-icon.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="家計簿">
  <link rel="manifest" href="manifest.json">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Yomogi&display=swap" rel="stylesheet">
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBlrNY3noyoLoC8KmstlJL9GON_4wpiTsQ",
      authDomain: "kakeibo-95d66.firebaseapp.com",
      projectId: "kakeibo-95d66",
      storageBucket: "kakeibo-95d66.firebasestorage.app",
      messagingSenderId: "640950783818",
      appId: "1:640950783818:web:f37d56db2eedead2567bb3"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
  </script>
  <style>
:root {
  /* 4px Grid Base */
  --space-1: 4px;
  --space-2: 8px;
  --space-3: 12px;
  --space-4: 16px;
  --space-6: 24px;
  --space-8: 32px;
  
  /* Colors - Warm Foundation */
  --bg-base: #f9f5f5;
  --bg-surface: #ffffff;
  --bg-muted: #f5f0f0;
  --fg-primary: #1a1818;
  --fg-secondary: #4a4545;
  --fg-muted: #7a7272;
  --fg-faint: #a89e9e;
  --accent: #e48bb0;
  --accent-hover: #d77da3;
  --accent-light: #fce8f1;
  --accent-subtle: rgba(228, 139, 176, 0.12);
  --success: #3d9a50;
  --error: #d14d4d;
  
  /* Borders & Shadows - Single Shadow Approach */
  --border: rgba(0, 0, 0, 0.08);
  --border-strong: rgba(0, 0, 0, 0.12);
  --shadow: 0 1px 3px rgba(0,0,0,0.08);
  --shadow-md: 0 2px 6px rgba(0,0,0,0.08);
  --shadow-lg: 0 4px 12px rgba(0,0,0,0.1);
  
  /* Border Radius - Consistent Scale */
  --radius-sm: 6px;
  --radius-md: 8px;
  --radius-lg: 12px;
  --radius-full: 9999px;
  
  /* Animation */
  --ease: cubic-bezier(0.25, 1, 0.5, 1);
  --duration: 150ms;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: 'Yomogi', -apple-system, BlinkMacSystemFont, 'Hiragino Sans', sans-serif;
  background: var(--bg-base);
  min-height: 100vh;
  color: var(--fg-primary);
  font-size: 14px;
  -webkit-font-smoothing: antialiased;
}
.app {
  max-width: 430px;
  margin: 0 auto;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  background: var(--bg-base);
}
.account-tabs {
  display: flex;
  gap: 8px;
  background: var(--accent);
  padding: 16px;
  box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
}
.account-tab {
  flex: 1;
  padding: 12px 16px;
  border: none;
  background: rgba(255, 255, 255, 0.2);
  color: rgba(255, 255, 255, 0.85);
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  border-radius: var(--radius-full);
  transition: all var(--duration) var(--ease);
}
.account-tab:hover { background: rgba(255, 255, 255, 0.3); color: #fff; }
.account-tab.active {
  background: #fff;
  color: var(--accent);
  box-shadow: var(--shadow);
}
.main-content { flex: 1; overflow-y: auto; padding-bottom: 88px; }
.screen { display: none; padding: 16px; }
.screen.active { display: block; }
.type-toggle {
  display: flex;
  background: var(--bg-surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-full);
  padding: 4px;
  margin-bottom: 16px;
  box-shadow: var(--shadow);
}
.type-btn {
  flex: 1;
  padding: 12px 16px;
  border: none;
  background: transparent;
  color: var(--fg-muted);
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  border-radius: var(--radius-full);
  transition: all var(--duration) var(--ease);
}
.type-btn:hover { color: var(--fg-secondary); background: var(--bg-muted); }
.type-btn.active { background: var(--accent); color: #fff; box-shadow: var(--shadow); }
.input-form {
  background: var(--bg-surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 16px;
  box-shadow: var(--shadow);
}
.amount-field {
  display: flex;
  align-items: center;
  background: var(--bg-muted);
  border-radius: var(--radius-md);
  padding: 16px;
  margin-bottom: 16px;
}
.amount-field input {
  flex: 1;
  border: none;
  background: transparent;
  font-size: 32px;
  font-weight: 500;
  color: var(--fg-primary);
  outline: none;
  font-variant-numeric: tabular-nums;
  width: 100%;
}
.amount-field input::placeholder { color: var(--fg-faint); }
.amount-field .yen { font-size: 18px; font-weight: 500; color: var(--fg-muted); }
.input-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 4px;
  border-bottom: 1px solid var(--border);
}
.input-row:last-of-type { border-bottom: none; }
.input-row .label { font-size: 14px; font-weight: 600; color: var(--fg-secondary); }
.input-row input, .input-row select {
  border: none;
  background: transparent;
  font-size: 14px;
  color: var(--fg-muted);
  text-align: right;
  outline: none;
  max-width: 55%;
  font-weight: 500;
}
.input-row select {
  appearance: none;
  cursor: pointer;
  padding-right: 16px;
  background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='7'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%237a7272' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E") no-repeat right center;
}
.save-btn {
  width: 100%;
  padding: 16px;
  background: var(--accent);
  border: none;
  border-radius: var(--radius-md);
  color: #fff;
  font-size: 16px;
  font-weight: 700;
  cursor: pointer;
  margin-top: 16px;
  box-shadow: var(--shadow);
  transition: all var(--duration) var(--ease);
}
.save-btn:hover {
  background: var(--accent-hover);
  box-shadow: var(--shadow-md);
}
.save-btn:active { transform: scale(0.98); }
.month-nav {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 24px;
  padding: 12px 0 16px;
}
.nav-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 36px;
  height: 36px;
  background: var(--bg-surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  font-size: 14px;
  color: var(--fg-muted);
  cursor: pointer;
  box-shadow: var(--shadow);
  transition: all var(--duration) var(--ease);
}
.nav-btn:hover { background: var(--bg-muted); color: var(--fg-primary); }
.nav-btn:active { transform: scale(0.95); }
.month-title { font-size: 18px; font-weight: 700; color: var(--fg-primary); letter-spacing: -0.02em; }
.calendar-grid {
  background: var(--bg-surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 16px;
  box-shadow: var(--shadow);
}
.weekdays {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  text-align: center;
  font-size: 11px;
  font-weight: 600;
  color: var(--fg-muted);
  padding: 8px 0 12px;
  border-bottom: 1px solid var(--border);
  text-transform: uppercase;
  letter-spacing: 0.05em;
}
.weekdays .sat { color: #5a9cf5; }
.weekdays .sun { color: var(--accent); }
.days { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; margin-top: 8px; }
.day-cell {
  aspect-ratio: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
  padding: 6px 2px;
  font-size: 13px;
  cursor: pointer;
  border-radius: var(--radius-sm);
  transition: all var(--duration) var(--ease);
}
.day-cell:hover { background: var(--accent-light); }
.day-cell.today { background: var(--accent); color: #fff; box-shadow: var(--shadow); }
.day-cell.today .day-amount { color: rgba(255, 255, 255, 0.9); }
.day-cell .day-number { font-weight: 600; }
.day-cell.sat .day-number { color: #5a9cf5; }
.day-cell.sun .day-number { color: var(--accent); }
.day-cell.today .day-number { color: #fff; }
.day-cell.other-month { opacity: 0.25; }
.day-cell .day-amount { font-size: 9px; font-weight: 600; color: var(--accent); margin-top: 2px; font-variant-numeric: tabular-nums; }
.summary-bar { display: flex; gap: 8px; margin: 16px 0; }
.summary-item {
  flex: 1;
  text-align: center;
  background: var(--bg-surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  padding: 12px 8px;
  box-shadow: var(--shadow);
}
.summary-label {
  font-size: 11px;
  font-weight: 600;
  color: var(--fg-muted);
  display: block;
  margin-bottom: 4px;
  text-transform: uppercase;
  letter-spacing: 0.03em;
}
.summary-value { font-size: 16px; font-weight: 700; color: var(--fg-primary); font-variant-numeric: tabular-nums; }
.summary-value.income { color: var(--success); }
.summary-value.expense { color: var(--error); }
.daily-list { margin-top: 16px; }
.daily-group {
  background: var(--bg-surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  margin-bottom: 12px;
  overflow: hidden;
  box-shadow: var(--shadow);
}
.daily-date {
  font-size: 12px;
  font-weight: 700;
  color: var(--fg-muted);
  padding: 8px 12px;
  background: var(--bg-muted);
  border-bottom: 1px solid var(--border);
}
.daily-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px;
  border-bottom: 1px solid var(--border);
  cursor: pointer;
  transition: background var(--duration);
}
.daily-item:last-child { border-bottom: none; }
.daily-item:hover { background: var(--accent-subtle); }
.daily-item-left { display: flex; align-items: center; gap: 12px; }
.daily-item-icon { width: 10px; height: 10px; border-radius: 50%; box-shadow: var(--shadow); }
.daily-item-category { font-size: 14px; font-weight: 600; color: var(--fg-primary); }
.daily-item-amount { font-size: 15px; font-weight: 700; font-variant-numeric: tabular-nums; }
.daily-item-amount.income { color: var(--fg-primary); }
.daily-item-amount.expense { color: var(--error); }
.graph-type-toggle {
  display: flex;
  background: var(--bg-surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-full);
  padding: 4px;
  margin-bottom: 16px;
  box-shadow: var(--shadow);
}
.graph-type-btn {
  flex: 1;
  padding: 8px 8px;
  border: none;
  background: transparent;
  color: var(--fg-muted);
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  border-radius: var(--radius-full);
  transition: all var(--duration) var(--ease);
}
.graph-type-btn:hover { color: var(--fg-secondary); background: var(--bg-muted); }
.graph-type-btn.active { background: var(--accent); color: #fff; box-shadow: var(--shadow); }
.chart-container {
  display: flex;
  justify-content: center;
  padding: 24px 0;
  background: var(--bg-surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  margin-bottom: 16px;
  box-shadow: var(--shadow);
}
.graph-total {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px;
  background: var(--bg-surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  margin-bottom: 16px;
  box-shadow: var(--shadow);
}
.graph-total span:first-child { font-size: 14px; font-weight: 600; color: var(--fg-secondary); }
.graph-total span:last-child { font-size: 18px; font-weight: 700; color: var(--fg-primary); font-variant-numeric: tabular-nums; }
.category-list {
  background: var(--bg-surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  overflow: hidden;
  box-shadow: var(--shadow);
}
.category-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 16px;
  border-bottom: 1px solid var(--border);
}
.category-item:last-child { border-bottom: none; }
.category-item-left { display: flex; align-items: center; gap: 12px; }
.category-dot { width: 12px; height: 12px; border-radius: 50%; box-shadow: var(--shadow); }
.category-name { font-size: 14px; font-weight: 600; color: var(--fg-primary); }
.category-amount { font-size: 14px; font-weight: 600; color: var(--fg-secondary); font-variant-numeric: tabular-nums; }
.settings-title { text-align: center; font-size: 18px; font-weight: 700; color: var(--accent); padding: 8px 0 16px; letter-spacing: -0.02em; }
.settings-section {
  background: var(--bg-surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 16px;
  margin-bottom: 16px;
  box-shadow: var(--shadow);
}
.settings-section h3 {
  font-size: 11px;
  font-weight: 700;
  color: var(--fg-muted);
  margin-bottom: 12px;
  padding-bottom: 8px;
  border-bottom: 1px solid var(--border);
  text-transform: uppercase;
  letter-spacing: 0.05em;
}
.settings-section .input-row {
  padding: 12px 0;
}
.settings-section .input-row input {
  background: var(--bg-muted);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 8px 12px;
  max-width: 50%;
}
.category-manager { margin-bottom: 12px; }
.category-edit-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 4px;
  border-bottom: 1px solid var(--border);
}
.category-edit-item:last-child { border-bottom: none; }
.category-edit-item span { font-size: 14px; font-weight: 600; color: var(--fg-primary); }
.delete-category-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 32px;
  height: 32px;
  background: var(--bg-muted);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--fg-muted);
  font-size: 18px;
  cursor: pointer;
  transition: all var(--duration);
}
.delete-category-btn:hover { background: #fce8e8; border-color: var(--error); color: var(--error); }
.add-category { display: flex; gap: 8px; margin-top: 12px; }
.add-category input {
  flex: 1;
  padding: 12px;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  font-size: 14px;
  background: var(--bg-muted);
  color: var(--fg-primary);
  outline: none;
  font-weight: 500;
  transition: all var(--duration);
}
.add-category input:focus { border-color: var(--accent); background: var(--bg-surface); box-shadow: 0 0 0 3px var(--accent-subtle); }
.add-category input::placeholder { color: var(--fg-faint); }
.add-btn {
  padding: 12px 16px;
  background: var(--accent);
  border: none;
  border-radius: var(--radius-sm);
  color: #fff;
  font-size: 14px;
  font-weight: 700;
  cursor: pointer;
  white-space: nowrap;
  box-shadow: var(--shadow);
  transition: all var(--duration);
}
.add-btn:hover { background: var(--accent-hover); }
.danger-btn {
  width: 100%;
  padding: 12px 16px;
  background: var(--bg-muted);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--fg-secondary);
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  margin-bottom: 8px;
  transition: all var(--duration);
}
.danger-btn:hover { background: var(--bg-surface); border-color: var(--border-strong); }
.bottom-nav {
  position: fixed;
  bottom: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 100%;
  max-width: 430px;
  display: flex;
  justify-content: space-around;
  background: var(--bg-surface);
  padding: 8px 12px 24px;
  border-top: 1px solid var(--border);
  box-shadow: 0 -2px 8px rgba(0,0,0,0.04);
}
.nav-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
  background: none;
  border: none;
  color: var(--fg-faint);
  font-size: 10px;
  font-weight: 600;
  cursor: pointer;
  padding: 8px 16px;
  border-radius: var(--radius-md);
  transition: all var(--duration) var(--ease);
}
.nav-item:hover { color: var(--fg-muted); background: var(--bg-muted); }
.nav-item.active { color: var(--accent); background: var(--accent-light); }
.nav-icon { width: 24px; height: 24px; fill: currentColor; }
.toast {
  position: fixed;
  bottom: 104px;
  left: 50%;
  transform: translateX(-50%);
  background: var(--fg-primary);
  color: #fff;
  padding: 12px 24px;
  border-radius: var(--radius-full);
  font-size: 14px;
  font-weight: 600;
  opacity: 0;
  transition: all var(--duration) var(--ease);
  z-index: 1000;
  box-shadow: var(--shadow-lg);
}
.toast.show { opacity: 1; transform: translateX(-50%) translateY(-4px); }
.report-year-select { display: flex; gap: 8px; align-items: center; margin-bottom: 12px; }
.report-year-select select {
  flex: 1;
  padding: 12px;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  font-size: 14px;
  background: var(--bg-muted);
  color: var(--fg-primary);
  font-family: inherit;
}
.report-btn { width: 100%; }
.report-modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.5);
  z-index: 2000;
  align-items: center;
  justify-content: center;
  padding: 16px;
}
.report-modal.show { display: flex; }
.report-content {
  background: var(--bg-surface);
  border-radius: var(--radius-lg);
  width: 100%;
  max-width: 400px;
  max-height: 80vh;
  display: flex;
  flex-direction: column;
  box-shadow: var(--shadow-lg);
}
.report-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px;
  border-bottom: 1px solid var(--border);
}
.report-header h3 { font-size: 16px; color: var(--accent); }
.report-close {
  width: 32px;
  height: 32px;
  border: none;
  background: var(--bg-muted);
  border-radius: var(--radius-sm);
  font-size: 18px;
  cursor: pointer;
  color: var(--fg-muted);
}
#report-text {
  flex: 1;
  margin: 16px;
  padding: 12px;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  font-family: inherit;
  font-size: 13px;
  line-height: 1.6;
  resize: none;
  min-height: 300px;
  background: var(--bg-muted);
  color: var(--fg-primary);
}
.report-content .save-btn { margin: 0 16px 16px; }
.day-modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.4);
  z-index: 2000;
  align-items: center;
  justify-content: center;
  padding: 24px;
}
.day-modal.show { display: flex; }
.day-modal-content {
  background: var(--bg-surface);
  border-radius: var(--radius-lg);
  width: 100%;
  max-width: 320px;
  padding: 16px;
  box-shadow: var(--shadow-lg);
}
.day-modal-header {
  text-align: center;
  font-size: 18px;
  font-weight: 700;
  color: var(--fg-primary);
  margin-bottom: 16px;
}
.day-modal-list {
  margin-bottom: 12px;
}
.day-modal-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 16px;
  background: var(--bg-muted);
  border-radius: var(--radius-md);
  margin-bottom: 8px;
  gap: 12px;
}
.day-modal-item-left {
  display: flex;
  align-items: center;
  gap: 8px;
  flex: 1;
  min-width: 0;
}
.day-modal-item-category {
  font-size: 14px;
  font-weight: 600;
  color: var(--fg-primary);
}
.day-modal-item-amount {
  font-size: 14px;
  font-weight: 700;
  color: var(--fg-primary);
}
.day-modal-item-amount.expense {
  color: var(--error);
}
.day-modal-delete {
  width: 28px;
  height: 28px;
  min-width: 28px;
  border: none;
  background: rgba(209, 77, 77, 0.1);
  border-radius: var(--radius-sm);
  color: var(--error);
  font-size: 16px;
  cursor: pointer;
  transition: all var(--duration);
  flex-shrink: 0;
  pointer-events: auto;
  position: relative;
  z-index: 10;
}
.day-modal-delete:hover {
  background: rgba(209, 77, 77, 0.2);
}
.day-modal-btn {
  width: 100%;
  padding: 12px;
  border-radius: var(--radius-md);
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
  margin-bottom: 8px;
  font-family: inherit;
  transition: all var(--duration);
}
.new-entry-btn {
  background: var(--bg-muted);
  border: none;
  color: var(--fg-primary);
}
.new-entry-btn:hover {
  background: var(--accent-light);
}
.cancel-btn {
  background: var(--bg-surface);
  border: 1px solid var(--border);
  color: var(--fg-muted);
  margin-bottom: 0;
}
.cancel-btn:hover {
  background: var(--bg-muted);
}
.day-modal-empty {
  text-align: center;
  color: var(--fg-muted);
  padding: 16px;
  font-size: 14px;
}
.theme-selector {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
}
.theme-btn {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 12px;
  background: var(--bg-muted);
  border: 2px solid transparent;
  border-radius: var(--radius-md);
  font-size: 14px;
  font-weight: 600;
  color: var(--fg-primary);
  cursor: pointer;
  font-family: inherit;
  transition: all var(--duration);
}
.theme-btn:hover {
  background: var(--bg-surface);
}
.theme-btn.active {
  border-color: var(--accent);
  background: var(--bg-surface);
}
.theme-color {
  width: 20px;
  height: 20px;
  border-radius: 50%;
  box-shadow: var(--shadow);
}
.savings-input-area {
  margin-bottom: 16px;
}
.savings-input-card {
  background: var(--bg-surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 12px;
  box-shadow: var(--shadow);
}
.savings-input-row {
  display: flex;
  gap: 8px;
  align-items: center;
}
.savings-input-row select {
  flex: 1;
  padding: 12px;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  font-size: 14px;
  background: var(--bg-muted);
  color: var(--fg-primary);
  font-family: inherit;
  min-width: 0;
}
.savings-amount-field {
  display: flex;
  align-items: center;
  background: var(--bg-muted);
  border-radius: var(--radius-sm);
  padding: 8px 12px;
  flex: 1;
  min-width: 0;
}
.savings-amount-field input {
  flex: 1;
  border: none;
  background: transparent;
  font-size: 16px;
  font-weight: 600;
  color: var(--fg-primary);
  outline: none;
  font-variant-numeric: tabular-nums;
  width: 100%;
  min-width: 0;
}
.savings-amount-field input::placeholder { color: var(--fg-faint); }
.savings-amount-field .yen { font-size: 14px; font-weight: 500; color: var(--fg-muted); }
.savings-add-btn {
  width: 44px;
  height: 44px;
  min-width: 44px;
  border: none;
  background: var(--accent);
  color: #fff;
  border-radius: var(--radius-sm);
  font-size: 20px;
  font-weight: 600;
  cursor: pointer;
  transition: all var(--duration);
}
.savings-add-btn:hover { background: var(--accent-hover); }
.category-item-right {
  display: flex;
  align-items: center;
  gap: 8px;
}
.savings-delete-btn {
  width: 24px;
  height: 24px;
  border: none;
  background: rgba(209, 77, 77, 0.1);
  border-radius: var(--radius-sm);
  color: var(--error);
  font-size: 14px;
  cursor: pointer;
  transition: all var(--duration);
}
.savings-delete-btn:hover {
  background: rgba(209, 77, 77, 0.2);
}
.savings-month-list {
  margin-top: 16px;
}
.savings-month-header {
  font-size: 14px;
  font-weight: 700;
  color: var(--fg-secondary);
  margin-bottom: 8px;
  padding: 0 4px;
}
.savings-month-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 16px;
  background: var(--bg-surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  margin-bottom: 8px;
}
.savings-month-item-name {
  font-size: 14px;
  font-weight: 600;
  color: var(--fg-primary);
}
.savings-month-item-right {
  display: flex;
  align-items: center;
  gap: 8px;
}
.savings-month-item-amount {
  font-size: 14px;
  font-weight: 600;
  color: var(--fg-secondary);
  font-variant-numeric: tabular-nums;
}
@media (max-width: 430px) { .app, .bottom-nav { max-width: 100%; } }

/* クラウド同期 */
.sync-status {
  position: fixed;
  top: 8px;
  right: 8px;
  background: var(--accent);
  color: #fff;
  padding: 6px 12px;
  border-radius: var(--radius-full);
  font-size: 12px;
  opacity: 0;
  transition: opacity 0.3s;
  z-index: 9999;
  pointer-events: none;
}
.sync-status.show { opacity: 1; }
.cloud-section {
  background: var(--accent-light);
  border-radius: var(--radius-md);
  padding: 16px;
  margin-top: 8px;
}
.cloud-status {
  font-size: 14px;
  margin-bottom: 12px;
  color: var(--fg-secondary);
}
.cloud-status.logged-in { color: var(--success); }
.cloud-login-form {
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.cloud-login-form input {
  padding: 10px 12px;
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  font-size: 14px;
}
.cloud-login-form input:focus {
  outline: none;
  border-color: var(--accent);
}
.cloud-btn {
  padding: 10px 16px;
  border: none;
  border-radius: var(--radius-md);
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: background 0.2s;
}
.cloud-btn.primary {
  background: var(--accent);
  color: #fff;
}
.cloud-btn.primary:hover { background: var(--accent-hover); }
.cloud-btn.secondary {
  background: var(--bg-muted);
  color: var(--fg-secondary);
}
.cloud-btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}
.cloud-error {
  color: var(--error);
  font-size: 13px;
  margin-top: 4px;
}
.cloud-actions {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}
.cloud-tabs {
  display: flex;
  gap: 0;
  margin-bottom: 12px;
  border-radius: var(--radius-md);
  overflow: hidden;
  border: 1px solid var(--border);
}
.cloud-tab {
  flex: 1;
  padding: 8px 12px;
  border: none;
  background: var(--bg-surface);
  font-size: 13px;
  cursor: pointer;
  transition: all 0.2s;
  color: var(--fg-secondary);
}
.cloud-tab.active {
  background: var(--accent);
  color: #fff;
}
  </style>
</head>
<body>
  <div class="sync-status" id="sync-status"></div>
  <div class="app">
    <div class="account-tabs">
      <button class="account-tab active" data-account="company">会社</button>
      <button class="account-tab" data-account="personal">個人</button>
    </div>
    <div class="main-content">
      <div class="screen active" id="input-screen">
        <div class="type-toggle">
          <button class="type-btn active" data-type="income">収入</button>
          <button class="type-btn" data-type="expense">支出</button>
        </div>
        <div class="input-form">
          <div class="input-field amount-field">
            <input type="number" id="amount" placeholder="" inputmode="numeric">
            <span class="yen">円</span>
          </div>
          <div class="input-row" id="category-row">
            <span class="label">カテゴリー</span>
            <select id="category"><option value="">選択してください</option></select>
          </div>
          <div class="input-row">
            <span class="label">メモ</span>
            <input type="text" id="memo" placeholder="メモを入力" autocomplete="off">
          </div>
          <div class="input-row">
            <span class="label">日付</span>
            <input type="date" id="date">
          </div>
          <button class="save-btn" id="save-btn">保存</button>
        </div>
      </div>
      <div class="screen" id="calendar-screen">
        <div class="month-nav">
          <button class="nav-btn" id="prev-month">◁</button>
          <span class="month-title" id="month-title">2026年01月</span>
          <button class="nav-btn" id="next-month">▷</button>
        </div>
        <div class="calendar-grid">
          <div class="weekdays">
            <span>月</span><span>火</span><span>水</span><span>木</span><span>金</span><span class="sat">土</span><span class="sun">日</span>
          </div>
          <div class="days" id="calendar-days"></div>
        </div>
        <div class="summary-bar">
          <div class="summary-item"><span class="summary-label">収入</span><span class="summary-value income" id="total-income">0円</span></div>
          <div class="summary-item"><span class="summary-label">支出</span><span class="summary-value expense" id="total-expense">0円</span></div>
          <div class="summary-item"><span class="summary-label">合計</span><span class="summary-value" id="total-balance">0円</span></div>
        </div>
        <div class="daily-list" id="daily-list"></div>
        <div class="day-modal" id="day-modal">
          <div class="day-modal-content">
            <div class="day-modal-header" id="day-modal-date">01/13</div>
            <div class="day-modal-list" id="day-modal-list"></div>
            <button class="day-modal-btn new-entry-btn" id="modal-new-entry">新規作成</button>
            <button class="day-modal-btn cancel-btn" id="modal-cancel">キャンセル</button>
          </div>
        </div>
      </div>
      <div class="screen" id="graph-screen">
        <div class="graph-type-toggle">
          <button class="graph-type-btn" data-gtype="expense">支出</button>
          <button class="graph-type-btn active" data-gtype="income">収入</button>
          <button class="graph-type-btn" data-gtype="balance">貯金額</button>
        </div>
        <div class="month-nav" id="graph-month-nav">
          <button class="nav-btn" id="graph-prev-month">◁</button>
          <span class="month-title" id="graph-month-title">2026年01月</span>
          <button class="nav-btn" id="graph-next-month">▷</button>
        </div>
        <div class="chart-container" id="chart-container"><canvas id="pie-chart" width="250" height="250"></canvas></div>
        <div class="graph-total" id="graph-total-area"><span>合計</span><span id="graph-total-value">0円</span></div>
        <div class="category-list" id="category-breakdown"></div>
        <div class="savings-input-area" id="savings-input-area" style="display:none;">
          <div class="month-nav" id="savings-month-nav">
            <button class="nav-btn" id="savings-prev-month">◁</button>
            <span class="month-title" id="savings-month-title">2026年01月</span>
            <button class="nav-btn" id="savings-next-month">▷</button>
          </div>
          <div class="savings-input-card">
            <div class="savings-input-row">
              <select id="savings-category"></select>
              <div class="savings-amount-field">
                <input type="number" id="savings-amount" placeholder="0" inputmode="numeric">
                <span class="yen">円</span>
              </div>
              <button class="savings-add-btn" id="add-savings">+</button>
            </div>
          </div>
          <div class="savings-month-list" id="savings-month-list"></div>
        </div>
      </div>
      <div class="screen" id="settings-screen">
        <h2 class="settings-title">設定</h2>
        <div class="settings-section">
          <h3>テーマカラー</h3>
          <div class="theme-selector">
            <button class="theme-btn active" data-theme="pink"><span class="theme-color" style="background: #e48bb0;"></span>ピンク</button>
            <button class="theme-btn" data-theme="black"><span class="theme-color" style="background: #3d3d3d;"></span>ブラック</button>
            <button class="theme-btn" data-theme="blue"><span class="theme-color" style="background: #4a90d9;"></span>ブルー</button>
            <button class="theme-btn" data-theme="purple"><span class="theme-color" style="background: #8b6eb8;"></span>パープル</button>
          </div>
        </div>
        <div class="settings-section">
          <h3>タブ名設定</h3>
          <div class="input-row">
            <span class="label">タブ1</span>
            <input type="text" id="tab1-name" placeholder="会社">
          </div>
          <div class="input-row">
            <span class="label">タブ2</span>
            <input type="text" id="tab2-name" placeholder="個人">
          </div>
        </div>
        <div class="settings-section">
          <h3>収入カテゴリー</h3>
          <div class="category-manager" id="income-categories"></div>
          <div class="add-category">
            <input type="text" id="new-income-category" placeholder="新しいカテゴリー">
            <button class="add-btn" data-for="income">追加</button>
          </div>
        </div>
        <div class="settings-section">
          <h3>支出カテゴリー</h3>
          <div class="category-manager" id="expense-categories"></div>
          <div class="add-category">
            <input type="text" id="new-expense-category" placeholder="新しいカテゴリー">
            <button class="add-btn" data-for="expense">追加</button>
          </div>
        </div>
        <div class="settings-section">
          <h3>貯金カテゴリー</h3>
          <div class="category-manager" id="savings-categories"></div>
          <div class="add-category">
            <input type="text" id="new-savings-category" placeholder="新しいカテゴリー">
            <button class="add-btn" data-for="savings">追加</button>
          </div>
        </div>
        <div class="settings-section">
          <h3>データ管理</h3>
          <button class="danger-btn" id="export-data">データをエクスポート</button>
          <button class="danger-btn" id="import-data">データをインポート</button>
          <input type="file" id="import-file" accept=".json" style="display:none">
        </div>
        <div class="settings-section">
          <h3>☁️ クラウド同期</h3>
          <p style="font-size:13px;color:var(--fg-muted);margin-bottom:12px;">ログインするとデータが自動でクラウドに保存され、他の端末でも使えます</p>
          <div class="cloud-section">
            <div id="cloud-logged-out">
              <div class="cloud-tabs">
                <button class="cloud-tab active" data-tab="login">ログイン</button>
                <button class="cloud-tab" data-tab="register">新規登録</button>
              </div>
              <div class="cloud-login-form" id="cloud-login-form">
                <input type="email" id="cloud-email" placeholder="メールアドレス">
                <input type="password" id="cloud-password" placeholder="パスワード">
                <button class="cloud-btn primary" id="cloud-login-btn">ログイン</button>
                <p class="cloud-error" id="cloud-error"></p>
              </div>
              <div class="cloud-login-form" id="cloud-register-form" style="display:none;">
                <input type="email" id="register-email" placeholder="メールアドレス">
                <input type="password" id="register-password" placeholder="パスワード（6文字以上）">
                <button class="cloud-btn primary" id="cloud-register-btn">新規登録</button>
                <p class="cloud-error" id="register-error"></p>
              </div>
            </div>
            <div id="cloud-logged-in" style="display:none;">
              <p class="cloud-status logged-in">✓ ログイン中: <span id="cloud-user-email"></span></p>
              <div class="cloud-actions">
                <button class="cloud-btn primary" id="cloud-sync-btn">今すぐ同期</button>
                <button class="cloud-btn secondary" id="cloud-logout-btn">ログアウト</button>
              </div>
            </div>
          </div>
        </div>
        <div class="settings-section">
          <h3>確定申告用レポート</h3>
          <div class="report-year-select">
            <select id="report-year"></select>
            <select id="report-tab">
              <option value="company">タブ1のみ</option>
              <option value="personal">タブ2のみ</option>
              <option value="both">両方</option>
            </select>
          </div>
          <button class="add-btn report-btn" id="generate-report">レポート作成</button>
        </div>
        <div class="report-modal" id="report-modal">
          <div class="report-content">
            <div class="report-header">
              <h3>確定申告用レポート</h3>
              <button class="report-close" id="close-report">×</button>
            </div>
            <textarea id="report-text" readonly></textarea>
            <button class="save-btn" id="copy-report">コピーする</button>
          </div>
        </div>
      </div>
    </div>
    <nav class="bottom-nav">
      <button class="nav-item active" data-screen="input">
        <svg viewBox="0 0 24 24" class="nav-icon"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
        <span>入力</span>
      </button>
      <button class="nav-item" data-screen="calendar">
        <svg viewBox="0 0 24 24" class="nav-icon"><path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM9 10H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2z"/></svg>
        <span>カレンダー</span>
      </button>
      <button class="nav-item" data-screen="graph">
        <svg viewBox="0 0 24 24" class="nav-icon"><path d="M11 2v20c-5.07-.5-9-4.79-9-10s3.93-9.5 9-10zm2.03 0v8.99H22c-.47-4.74-4.24-8.52-8.97-8.99zm0 11.01V22c4.74-.47 8.5-4.25 8.97-8.99h-8.97z"/></svg>
        <span>グラフ</span>
      </button>
      <button class="nav-item" data-screen="settings">
        <svg viewBox="0 0 24 24" class="nav-icon"><path d="M19.14 12.94c.04-.31.06-.63.06-.94 0-.31-.02-.63-.06-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
        <span>設定</span>
      </button>
    </nav>
  </div>
  <script>
const DEFAULT_CATEGORIES = {
  company: {
    income: ['給料', 'その他'],
    expense: ['経費', '広告費', '通信費', 'ツール代', 'その他'],
    savings: ['事業積立', '設備投資用', 'その他']
  },
  personal: {
    income: ['給料', 'その他'],
    expense: ['食費', '外食', '日用品', '交通費', '光熱費', '通信費', '娯楽', '医療費', '教育費', 'その他'],
    savings: ['NISA', '車貯金', '子供用', '旅行用', '緊急用', 'その他']
  }
};
const COLORS = ['#f5a0a0','#e8b4b8','#a0c4f5','#f5d5a0','#a0f5c4','#d5a0f5','#f5a0d5','#a0f5f5','#c4f5a0','#f5c4a0','#b8e8d4','#e8b8d4','#d4b8e8','#b8d4e8','#e8d4b8'];
let state = {
  currentAccount: 'company',
  currentType: 'income',
  currentDate: new Date(),
  graphType: 'income',
  graphDate: new Date(),
  savingsDate: new Date(),
  entries: { company: [], personal: [] },
  categories: JSON.parse(JSON.stringify(DEFAULT_CATEGORIES)),
  tabNames: { company: '会社', personal: '家計簿' },
  theme: 'pink',
  savings: { company: {}, personal: {} }
};
const THEMES = {
  pink: {
    accent: '#e48bb0',
    accentHover: '#d77da3',
    accentLight: '#fce8f1',
    accentSubtle: 'rgba(228, 139, 176, 0.12)',
    bgBase: '#f9f5f5',
    bgMuted: '#f5f0f0'
  },
  black: {
    accent: '#3d3d3d',
    accentHover: '#2a2a2a',
    accentLight: '#f0f0f0',
    accentSubtle: 'rgba(61, 61, 61, 0.08)',
    bgBase: '#f7f7f7',
    bgMuted: '#eeeeee'
  },
  blue: {
    accent: '#4a90d9',
    accentHover: '#3a7fc8',
    accentLight: '#e8f2fc',
    accentSubtle: 'rgba(74, 144, 217, 0.1)',
    bgBase: '#f5f8fb',
    bgMuted: '#edf2f7'
  },
  purple: {
    accent: '#8b6eb8',
    accentHover: '#7a5da7',
    accentLight: '#f3eef8',
    accentSubtle: 'rgba(139, 110, 184, 0.1)',
    bgBase: '#f8f5fa',
    bgMuted: '#f0eaf5'
  }
};
let currentUser = null;
let saveTimeout = null;

function loadDataFromObject(data) {
  state.entries = data.entries || { company: [], personal: [] };
  state.categories = data.categories || JSON.parse(JSON.stringify(DEFAULT_CATEGORIES));
  if (!state.categories.company.savings) {
    state.categories.company.savings = DEFAULT_CATEGORIES.company.savings.slice();
  }
  if (!state.categories.personal.savings) {
    state.categories.personal.savings = DEFAULT_CATEGORIES.personal.savings.slice();
  }
  state.tabNames = data.tabNames || { company: '会社', personal: '家計簿' };
  state.theme = data.theme || 'pink';
  state.savings = data.savings || { company: {}, personal: {} };
  state.currentAccount = data.currentAccount || 'company';
}

function loadData() {
  const saved = localStorage.getItem('kakeibo_data');
  if (saved) {
    loadDataFromObject(JSON.parse(saved));
  }
}

function getDataObject() {
  return { entries: state.entries, categories: state.categories, tabNames: state.tabNames, theme: state.theme, savings: state.savings, currentAccount: state.currentAccount };
}

function saveData() {
  const data = getDataObject();
  localStorage.setItem('kakeibo_data', JSON.stringify(data));
  
  // ログイン中ならFirestoreにも保存（デバウンス）
  if (currentUser) {
    if (saveTimeout) clearTimeout(saveTimeout);
    saveTimeout = setTimeout(async () => {
      try {
        showSyncStatus('同期中...');
        await db.collection('users').doc(currentUser.uid).set(data);
        showSyncStatus('✓ 保存完了');
      } catch (e) {
        console.log('Firestore保存エラー:', e);
        showSyncStatus('同期エラー');
      }
    }, 1500);
  }
}

function showSyncStatus(msg) {
  const el = document.getElementById('sync-status');
  if (!el) return;
  el.textContent = msg;
  el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), 2000);
}

async function syncFromCloud() {
  if (!currentUser) return;
  try {
    showSyncStatus('読み込み中...');
    const doc = await db.collection('users').doc(currentUser.uid).get();
    if (doc.exists) {
      loadDataFromObject(doc.data());
      localStorage.setItem('kakeibo_data', JSON.stringify(getDataObject()));
      document.querySelectorAll('.account-tab').forEach(t => {
        t.classList.toggle('active', t.dataset.account === state.currentAccount);
      });
      updateCategorySelect();
      updateTabNames();
      applyTheme(state.theme);
      renderCalendar();
      renderGraph();
      renderSettings();
      showSyncStatus('✓ 同期完了');
    } else {
      // クラウドにデータがない場合は現在のデータをアップロード
      await db.collection('users').doc(currentUser.uid).set(getDataObject());
      showSyncStatus('✓ アップロード完了');
    }
  } catch (e) {
    console.log('同期エラー:', e);
    showSyncStatus('同期エラー');
  }
}

function updateCloudUI() {
  const loggedOut = document.getElementById('cloud-logged-out');
  const loggedIn = document.getElementById('cloud-logged-in');
  const userEmail = document.getElementById('cloud-user-email');
  if (!loggedOut || !loggedIn) return;
  
  if (currentUser) {
    loggedOut.style.display = 'none';
    loggedIn.style.display = 'block';
    userEmail.textContent = currentUser.email;
  } else {
    loggedOut.style.display = 'block';
    loggedIn.style.display = 'none';
  }
}

function setupCloudEvents() {
  // タブ切り替え
  document.querySelectorAll('.cloud-tab').forEach(tab => {
    tab.addEventListener('click', () => {
      document.querySelectorAll('.cloud-tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      const isLogin = tab.dataset.tab === 'login';
      document.getElementById('cloud-login-form').style.display = isLogin ? 'flex' : 'none';
      document.getElementById('cloud-register-form').style.display = isLogin ? 'none' : 'flex';
    });
  });

  // ログインボタン
  document.getElementById('cloud-login-btn')?.addEventListener('click', async () => {
    const email = document.getElementById('cloud-email').value.trim();
    const password = document.getElementById('cloud-password').value;
    const errorEl = document.getElementById('cloud-error');
    const btn = document.getElementById('cloud-login-btn');
    
    if (!email || !password) {
      errorEl.textContent = '入力してください';
      return;
    }
    btn.disabled = true;
    btn.textContent = 'ログイン中...';
    errorEl.textContent = '';
    
    try {
      await auth.signInWithEmailAndPassword(email, password);
      document.getElementById('cloud-email').value = '';
      document.getElementById('cloud-password').value = '';
    } catch (e) {
      errorEl.textContent = 'ログイン失敗';
    }
    btn.disabled = false;
    btn.textContent = 'ログイン';
  });
  
  // 新規登録ボタン
  document.getElementById('cloud-register-btn')?.addEventListener('click', async () => {
    const email = document.getElementById('register-email').value.trim();
    const password = document.getElementById('register-password').value;
    const errorEl = document.getElementById('register-error');
    const btn = document.getElementById('cloud-register-btn');
    
    if (!email || !password) {
      errorEl.textContent = '入力してください';
      return;
    }
    if (password.length < 6) {
      errorEl.textContent = 'パスワードは6文字以上';
      return;
    }
    btn.disabled = true;
    btn.textContent = '登録中...';
    errorEl.textContent = '';
    
    try {
      await auth.createUserWithEmailAndPassword(email, password);
      document.getElementById('register-email').value = '';
      document.getElementById('register-password').value = '';
    } catch (e) {
      if (e.code === 'auth/email-already-in-use') {
        errorEl.textContent = 'このメールは登録済み';
      } else {
        errorEl.textContent = '登録失敗';
      }
    }
    btn.disabled = false;
    btn.textContent = '新規登録';
  });
  
  // ログアウトボタン
  document.getElementById('cloud-logout-btn')?.addEventListener('click', async () => {
    await auth.signOut();
  });
  
  // 同期ボタン
  document.getElementById('cloud-sync-btn')?.addEventListener('click', syncFromCloud);
  
  // Enterキーでログイン/登録
  document.getElementById('cloud-password')?.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') document.getElementById('cloud-login-btn')?.click();
  });
  document.getElementById('register-password')?.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') document.getElementById('cloud-register-btn')?.click();
  });
  
  // 認証状態監視
  auth.onAuthStateChanged(async (user) => {
    currentUser = user;
    updateCloudUI();
    if (user) {
      await syncFromCloud();
    }
  });
}

function init() {
  loadData();
  setupEventListeners();
  setupCloudEvents();
  document.querySelectorAll('.account-tab').forEach(t => {
    t.classList.toggle('active', t.dataset.account === state.currentAccount);
  });
  updateCategorySelect();
  setDefaultDate();
  updateTabNames();
  applyTheme(state.theme);
  renderCalendar();
  renderGraph();
  renderSettings();
}
function setupEventListeners() {
  document.querySelectorAll('.account-tab').forEach(tab => {
    tab.addEventListener('click', () => {
      document.querySelectorAll('.account-tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      state.currentAccount = tab.dataset.account;
      saveData();
      updateCategorySelect();
      renderCalendar();
      renderGraph();
      renderSettings();
    });
  });
  document.querySelectorAll('.type-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      state.currentType = btn.dataset.type;
      updateCategorySelect();
    });
  });
  document.getElementById('save-btn').addEventListener('click', saveEntry);
  document.querySelectorAll('.nav-item').forEach(item => {
    item.addEventListener('click', () => {
      document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
      item.classList.add('active');
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.getElementById(`${item.dataset.screen}-screen`).classList.add('active');
      if (item.dataset.screen === 'calendar') renderCalendar();
      if (item.dataset.screen === 'graph') renderGraph();
      if (item.dataset.screen === 'settings') renderSettings();
    });
  });
  document.getElementById('prev-month').addEventListener('click', () => { state.currentDate.setMonth(state.currentDate.getMonth() - 1); renderCalendar(); });
  document.getElementById('next-month').addEventListener('click', () => { state.currentDate.setMonth(state.currentDate.getMonth() + 1); renderCalendar(); });
  document.querySelectorAll('.graph-type-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.graph-type-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      state.graphType = btn.dataset.gtype;
      renderGraph();
    });
  });
  document.getElementById('graph-prev-month').addEventListener('click', () => { state.graphDate.setMonth(state.graphDate.getMonth() - 1); renderGraph(); });
  document.getElementById('graph-next-month').addEventListener('click', () => { state.graphDate.setMonth(state.graphDate.getMonth() + 1); renderGraph(); });
  document.getElementById('savings-prev-month').addEventListener('click', () => { state.savingsDate.setMonth(state.savingsDate.getMonth() - 1); renderGraph(); });
  document.getElementById('savings-next-month').addEventListener('click', () => { state.savingsDate.setMonth(state.savingsDate.getMonth() + 1); renderGraph(); });
  document.querySelectorAll('.add-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const type = btn.dataset.for;
      if (!type) return;
      const input = document.getElementById(`new-${type}-category`);
      const value = input.value.trim();
      if (value) {
        if (!state.categories[state.currentAccount][type]) {
          state.categories[state.currentAccount][type] = [];
        }
        state.categories[state.currentAccount][type].push(value);
        saveData();
        input.value = '';
        renderSettings();
        updateCategorySelect();
      }
    });
  });
  document.getElementById('export-data').addEventListener('click', exportData);
  document.getElementById('import-data').addEventListener('click', () => { document.getElementById('import-file').click(); });
  document.getElementById('import-file').addEventListener('change', importData);
  document.getElementById('generate-report').addEventListener('click', generateReport);
  document.getElementById('close-report').addEventListener('click', () => { document.getElementById('report-modal').classList.remove('show'); });
  document.getElementById('copy-report').addEventListener('click', copyReport);
  document.getElementById('modal-cancel').addEventListener('click', () => { document.getElementById('day-modal').classList.remove('show'); });
  document.getElementById('day-modal').addEventListener('click', (e) => { if (e.target.id === 'day-modal') document.getElementById('day-modal').classList.remove('show'); });
  document.getElementById('modal-new-entry').addEventListener('click', openNewEntryFromModal);
  document.querySelectorAll('.theme-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.theme-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      state.theme = btn.dataset.theme;
      applyTheme(state.theme);
      saveData();
    });
  });
  document.getElementById('add-savings').addEventListener('click', saveSavings);
  initReportYears();
}
function updateCategorySelect() {
  const select = document.getElementById('category');
  const categories = state.categories[state.currentAccount][state.currentType];
  select.innerHTML = '<option value="">選択してください</option>';
  categories.forEach(cat => {
    const option = document.createElement('option');
    option.value = cat;
    option.textContent = cat;
    select.appendChild(option);
  });
}
function updateTabNames() {
  const tabs = document.querySelectorAll('.account-tab');
  tabs[0].textContent = state.tabNames.company;
  tabs[1].textContent = state.tabNames.personal;
  document.getElementById('tab1-name').value = state.tabNames.company;
  document.getElementById('tab2-name').value = state.tabNames.personal;
}
function setDefaultDate() {
  const today = new Date();
  document.getElementById('date').value = today.toISOString().split('T')[0];
}
function saveEntry() {
  const amount = parseInt(document.getElementById('amount').value);
  const category = document.getElementById('category').value;
  const memo = document.getElementById('memo').value;
  const date = document.getElementById('date').value;
  if (!amount || !category || !date) { showToast('金額、カテゴリー、日付を入力してください'); return; }
  const entry = { id: Date.now(), type: state.currentType, amount, category, memo, date };
  state.entries[state.currentAccount].push(entry);
  saveData();
  document.getElementById('amount').value = '';
  document.getElementById('memo').value = '';
  // カテゴリーと日付は連続入力のために保持
  showToast('保存しました！');
}
function renderCalendar() {
  const year = state.currentDate.getFullYear();
  const month = state.currentDate.getMonth();
  document.getElementById('month-title').textContent = `${year}年${String(month + 1).padStart(2, '0')}月`;
  const firstDay = new Date(year, month, 1);
  const lastDay = new Date(year, month + 1, 0);
  const startDay = (firstDay.getDay() + 6) % 7;
  const daysContainer = document.getElementById('calendar-days');
  daysContainer.innerHTML = '';
  const monthEntries = state.entries[state.currentAccount].filter(e => {
    const d = new Date(e.date);
    return d.getFullYear() === year && d.getMonth() === month;
  });
  const dailyTotals = {};
  monthEntries.forEach(e => {
    if (!dailyTotals[e.date]) dailyTotals[e.date] = { income: 0, expense: 0 };
    if (e.type === 'income') dailyTotals[e.date].income += e.amount;
    else dailyTotals[e.date].expense += e.amount;
  });
  const prevMonth = new Date(year, month, 0);
  for (let i = startDay - 1; i >= 0; i--) {
    const dayNum = prevMonth.getDate() - i;
    daysContainer.appendChild(createDayCell(dayNum, true, (startDay - 1 - i) % 7));
  }
  const today = new Date();
  for (let i = 1; i <= lastDay.getDate(); i++) {
    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
    const dayOfWeek = (startDay + i - 1) % 7;
    const isToday = today.getFullYear() === year && today.getMonth() === month && today.getDate() === i;
    daysContainer.appendChild(createDayCell(i, false, dayOfWeek, isToday, dailyTotals[dateStr], dateStr));
  }
  const remaining = 42 - (startDay + lastDay.getDate());
  for (let i = 1; i <= remaining; i++) {
    daysContainer.appendChild(createDayCell(i, true, (startDay + lastDay.getDate() + i - 1) % 7));
  }
  let totalIncome = 0, totalExpense = 0;
  monthEntries.forEach(e => { if (e.type === 'income') totalIncome += e.amount; else totalExpense += e.amount; });
  document.getElementById('total-income').textContent = formatCurrency(totalIncome);
  document.getElementById('total-expense').textContent = formatCurrency(totalExpense);
  document.getElementById('total-balance').textContent = formatCurrency(totalIncome - totalExpense);
  renderDailyList(monthEntries);
}
function createDayCell(dayNum, isOtherMonth, dayOfWeek, isToday = false, total = null, dateStr = null) {
  const cell = document.createElement('div');
  cell.className = 'day-cell';
  if (isOtherMonth) cell.classList.add('other-month');
  if (isToday) cell.classList.add('today');
  if (dayOfWeek === 5) cell.classList.add('sat');
  if (dayOfWeek === 6) cell.classList.add('sun');
  
  if (dateStr && !isOtherMonth) {
    cell.addEventListener('click', () => openDayModal(dateStr));
  }
  
  const numSpan = document.createElement('span');
  numSpan.className = 'day-number';
  numSpan.textContent = dayNum;
  cell.appendChild(numSpan);
  if (total) {
    const amountSpan = document.createElement('span');
    amountSpan.className = 'day-amount';
    if (total.income > 0) {
      amountSpan.textContent = formatCurrency(total.income, true);
    }
    cell.appendChild(amountSpan);
  }
  return cell;
}
function renderDailyList(entries) {
  const listContainer = document.getElementById('daily-list');
  listContainer.innerHTML = '';
  const grouped = {};
  entries.forEach(e => { if (!grouped[e.date]) grouped[e.date] = []; grouped[e.date].push(e); });
  const sortedDates = Object.keys(grouped).sort((a, b) => new Date(b) - new Date(a));
  sortedDates.forEach(date => {
    const group = document.createElement('div');
    group.className = 'daily-group';
    const d = new Date(date);
    const weekdays = ['日', '月', '火', '水', '木', '金', '土'];
    const dateLabel = document.createElement('div');
    dateLabel.className = 'daily-date';
    dateLabel.textContent = `${String(d.getMonth() + 1).padStart(2, '0')}月${String(d.getDate()).padStart(2, '0')}日(${weekdays[d.getDay()]})`;
    group.appendChild(dateLabel);
    grouped[date].forEach((entry, idx) => {
      const item = document.createElement('div');
      item.className = 'daily-item';
      const amountDisplay = entry.type === 'expense' ? `-${formatCurrency(entry.amount)}` : formatCurrency(entry.amount);
      item.innerHTML = `<div class="daily-item-left"><div class="daily-item-icon" style="background: ${COLORS[idx % COLORS.length]}"></div><span class="daily-item-category">${entry.category}</span></div><span class="daily-item-amount ${entry.type}">${amountDisplay}</span>`;
      let pressTimer;
      item.addEventListener('mousedown', () => { pressTimer = setTimeout(() => { deleteEntry(entry.id); }, 800); });
      item.addEventListener('mouseup', () => clearTimeout(pressTimer));
      item.addEventListener('mouseleave', () => clearTimeout(pressTimer));
      item.addEventListener('touchstart', () => { pressTimer = setTimeout(() => { deleteEntry(entry.id); }, 800); });
      item.addEventListener('touchend', () => clearTimeout(pressTimer));
      group.appendChild(item);
    });
    listContainer.appendChild(group);
  });
}
function deleteEntry(id) {
  state.entries[state.currentAccount] = state.entries[state.currentAccount].filter(e => e.id !== id);
  saveData();
  renderCalendar();
  renderGraph();
  showToast('削除しました');
}
let selectedModalDate = null;
function openDayModal(dateStr) {
  selectedModalDate = dateStr;
  const d = new Date(dateStr);
  document.getElementById('day-modal-date').textContent = `${String(d.getMonth() + 1).padStart(2, '0')}/${String(d.getDate()).padStart(2, '0')}`;
  
  const dayEntries = state.entries[state.currentAccount].filter(e => e.date === dateStr);
  const listContainer = document.getElementById('day-modal-list');
  listContainer.innerHTML = '';
  
  if (dayEntries.length === 0) {
    listContainer.innerHTML = '<div class="day-modal-empty">この日の記録はありません</div>';
  } else {
    dayEntries.forEach(entry => {
      const item = document.createElement('div');
      item.className = 'day-modal-item';
      const amountDisplay = entry.type === 'expense' ? `-${formatCurrency(entry.amount)}` : formatCurrency(entry.amount);
      
      item.innerHTML = `
        <div class="day-modal-item-left">
          <span class="day-modal-item-category">${entry.category}</span>
        </div>
        <span class="day-modal-item-amount ${entry.type}">${amountDisplay}</span>
        <button type="button" class="day-modal-delete" data-id="${entry.id}">×</button>
      `;
      
      listContainer.appendChild(item);
    });
  }
  
  // イベント委任で削除ボタンを処理
  listContainer.onclick = function(e) {
    const btn = e.target.closest('.day-modal-delete');
    if (btn) {
      e.preventDefault();
      e.stopPropagation();
      const id = parseInt(btn.dataset.id);
      deleteEntry(id);
      openDayModal(selectedModalDate);
    }
  };
  
  document.getElementById('day-modal').classList.add('show');
}
function openNewEntryFromModal() {
  document.getElementById('day-modal').classList.remove('show');
  document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
  document.querySelector('[data-screen="input"]').classList.add('active');
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById('input-screen').classList.add('active');
  if (selectedModalDate) {
    document.getElementById('date').value = selectedModalDate;
  }
}
function saveSavings() {
  const year = state.savingsDate.getFullYear();
  const month = state.savingsDate.getMonth();
  const monthKey = `${year}-${String(month + 1).padStart(2, '0')}`;
  const category = document.getElementById('savings-category').value;
  const amount = parseInt(document.getElementById('savings-amount').value) || 0;
  
  if (!category || !amount) {
    showToast('カテゴリと金額を入力してください');
    return;
  }
  
  if (!state.savings[state.currentAccount][monthKey]) {
    state.savings[state.currentAccount][monthKey] = {};
  }
  
  // 既存の金額に追加（上書きではなく追加）
  if (!state.savings[state.currentAccount][monthKey][category]) {
    state.savings[state.currentAccount][monthKey][category] = 0;
  }
  state.savings[state.currentAccount][monthKey][category] += amount;
  
  saveData();
  document.getElementById('savings-amount').value = '';
  renderGraph();
  showToast('貯金を追加しました');
}

function getTotalSavings() {
  // 全期間の貯金を集計
  const allSavings = state.savings[state.currentAccount];
  const totals = {};
  Object.values(allSavings).forEach(monthData => {
    Object.entries(monthData).forEach(([cat, amount]) => {
      if (!totals[cat]) totals[cat] = 0;
      totals[cat] += amount;
    });
  });
  return totals;
}

function renderGraph() {
  const year = state.graphDate.getFullYear();
  const month = state.graphDate.getMonth();
  const monthKey = `${year}-${String(month + 1).padStart(2, '0')}`;
  document.getElementById('graph-month-title').textContent = `${year}年${String(month + 1).padStart(2, '0')}月`;
  const monthEntries = state.entries[state.currentAccount].filter(e => {
    const d = new Date(e.date);
    return d.getFullYear() === year && d.getMonth() === month;
  });
  
  // 貯金額タブの場合
  if (state.graphType === 'balance') {
    // 貯金入力用の月タイトルを更新
    const savingsYear = state.savingsDate.getFullYear();
    const savingsMonth = state.savingsDate.getMonth();
    const savingsMonthKey = `${savingsYear}-${String(savingsMonth + 1).padStart(2, '0')}`;
    document.getElementById('savings-month-title').textContent = `${savingsYear}年${String(savingsMonth + 1).padStart(2, '0')}月`;
    
    document.getElementById('chart-container').style.display = 'flex';
    document.getElementById('graph-total-area').style.display = 'flex';
    document.getElementById('savings-input-area').style.display = 'block';
    document.getElementById('graph-month-nav').style.display = 'none';
    document.getElementById('savings-month-nav').style.display = 'flex';
    
    // カテゴリセレクトを更新
    const select = document.getElementById('savings-category');
    const categories = state.categories[state.currentAccount].savings || DEFAULT_CATEGORIES[state.currentAccount].savings;
    select.innerHTML = '<option value="">カテゴリ</option>';
    categories.forEach(cat => {
      const option = document.createElement('option');
      option.value = cat;
      option.textContent = cat;
      select.appendChild(option);
    });
    
    // 全期間の累計を取得
    const categoryTotals = getTotalSavings();
    const total = Object.values(categoryTotals).reduce((sum, v) => sum + v, 0);
    document.getElementById('graph-total-value').textContent = formatCurrency(total);
    
    const chartData = Object.entries(categoryTotals).map(([name, value], idx) => ({ name, value, color: COLORS[idx % COLORS.length] }));
    drawPieChart(chartData);
    
    // 累計のカテゴリ別リスト
    const listContainer = document.getElementById('category-breakdown');
    listContainer.innerHTML = '';
    chartData.sort((a, b) => b.value - a.value).forEach((item, idx) => {
      const el = document.createElement('div');
      el.className = 'category-item';
      el.innerHTML = `
        <div class="category-item-left">
          <div class="category-dot" style="background: ${item.color}"></div>
          <span class="category-name">${item.name}</span>
        </div>
        <span class="category-amount">${formatCurrency(item.value)}</span>`;
      listContainer.appendChild(el);
    });
    
    // その月の入力リスト
    const monthListContainer = document.getElementById('savings-month-list');
    monthListContainer.innerHTML = '';
    const monthSavings = state.savings[state.currentAccount][savingsMonthKey] || {};
    const monthEntryData = Object.entries(monthSavings);
    
    if (monthEntryData.length > 0) {
      const monthTotal = monthEntryData.reduce((sum, [, v]) => sum + v, 0);
      const header = document.createElement('div');
      header.className = 'savings-month-header';
      header.textContent = `${savingsMonth + 1}月の貯金: ${formatCurrency(monthTotal)}`;
      monthListContainer.appendChild(header);
      
      monthEntryData.forEach(([cat, amount]) => {
        const el = document.createElement('div');
        el.className = 'savings-month-item';
        el.innerHTML = `
          <span class="savings-month-item-name">${cat}</span>
          <div class="savings-month-item-right">
            <span class="savings-month-item-amount">${formatCurrency(amount)}</span>
            <button class="savings-delete-btn" data-month="${savingsMonthKey}" data-category="${cat}">×</button>
          </div>`;
        monthListContainer.appendChild(el);
      });
      
      // 削除ボタンのイベント
      monthListContainer.onclick = function(e) {
        const btn = e.target.closest('.savings-delete-btn');
        if (btn) {
          const monthKey = btn.dataset.month;
          const cat = btn.dataset.category;
          delete state.savings[state.currentAccount][monthKey][cat];
          saveData();
          renderGraph();
        }
      };
    }
    return;
  }
  
  // 収入・支出タブの場合
  document.getElementById('chart-container').style.display = 'flex';
  document.getElementById('graph-total-area').style.display = 'flex';
  document.getElementById('savings-input-area').style.display = 'none';
  document.getElementById('graph-month-nav').style.display = 'flex';
  document.getElementById('savings-month-nav').style.display = 'none';
  
  const filteredEntries = monthEntries.filter(e => e.type === state.graphType);
  const categoryTotals = {};
  filteredEntries.forEach(e => { if (!categoryTotals[e.category]) categoryTotals[e.category] = 0; categoryTotals[e.category] += e.amount; });
  const total = Object.values(categoryTotals).reduce((sum, v) => sum + v, 0);
  document.getElementById('graph-total-value').textContent = formatCurrency(total);
  const chartData = Object.entries(categoryTotals).map(([name, value], idx) => ({ name, value, color: COLORS[idx % COLORS.length] }));
  drawPieChart(chartData);
  const listContainer = document.getElementById('category-breakdown');
  listContainer.innerHTML = '';
  chartData.sort((a, b) => b.value - a.value).forEach(item => {
    const el = document.createElement('div');
    el.className = 'category-item';
    el.innerHTML = `<div class="category-item-left"><div class="category-dot" style="background: ${item.color}"></div><span class="category-name">${item.name}</span></div><span class="category-amount">${formatCurrency(item.value)}</span>`;
    listContainer.appendChild(el);
  });
}
function drawPieChart(data) {
  const canvas = document.getElementById('pie-chart');
  const ctx = canvas.getContext('2d');
  const centerX = canvas.width / 2;
  const centerY = canvas.height / 2;
  const radius = 100;
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  if (data.length === 0) { ctx.beginPath(); ctx.arc(centerX, centerY, radius, 0, Math.PI * 2); ctx.fillStyle = '#f0f0f0'; ctx.fill(); return; }
  const total = data.reduce((sum, d) => sum + d.value, 0);
  let startAngle = -Math.PI / 2;
  data.forEach(item => {
    const sliceAngle = (item.value / total) * Math.PI * 2;
    ctx.beginPath();
    ctx.moveTo(centerX, centerY);
    ctx.arc(centerX, centerY, radius, startAngle, startAngle + sliceAngle);
    ctx.closePath();
    ctx.fillStyle = item.color;
    ctx.fill();
    if (item.value / total > 0.05) {
      const labelAngle = startAngle + sliceAngle / 2;
      const labelX = centerX + Math.cos(labelAngle) * (radius * 0.65);
      const labelY = centerY + Math.sin(labelAngle) * (radius * 0.65);
      ctx.fillStyle = '#fff';
      ctx.font = '11px sans-serif';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      let label = item.name;
      if (label.length > 5) label = label.substring(0, 4) + '…';
      ctx.fillText(label, labelX, labelY);
    }
    startAngle += sliceAngle;
  });
  ctx.beginPath();
  ctx.arc(centerX, centerY, radius * 0.5, 0, Math.PI * 2);
  ctx.fillStyle = '#fff';
  ctx.fill();
}
function renderSettings() {
  ['income', 'expense', 'savings'].forEach(type => {
    const container = document.getElementById(`${type}-categories`);
    container.innerHTML = '';
    const cats = state.categories[state.currentAccount][type] || [];
    cats.forEach((cat, idx) => {
      const item = document.createElement('div');
      item.className = 'category-edit-item';
      item.innerHTML = `<span>${cat}</span><button class="delete-category-btn" data-type="${type}" data-index="${idx}">×</button>`;
      container.appendChild(item);
    });
  });
  document.querySelectorAll('.delete-category-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const type = btn.dataset.type;
      const index = parseInt(btn.dataset.index);
      state.categories[state.currentAccount][type].splice(index, 1);
      saveData();
      renderSettings();
      updateCategorySelect();
    });
  });
  document.getElementById('tab1-name').value = state.tabNames.company;
  document.getElementById('tab2-name').value = state.tabNames.personal;
  document.getElementById('tab1-name').onchange = (e) => {
    state.tabNames.company = e.target.value || '会社';
    saveData();
    updateTabNames();
    updateReportTabSelect();
  };
  document.getElementById('tab2-name').onchange = (e) => {
    state.tabNames.personal = e.target.value || '個人';
    saveData();
    updateTabNames();
    updateReportTabSelect();
  };
}
function exportData() {
  const data = JSON.stringify({ entries: state.entries, categories: state.categories, tabNames: state.tabNames, theme: state.theme, savings: state.savings }, null, 2);
  const blob = new Blob([data], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `kakeibo_backup_${new Date().toISOString().split('T')[0]}.json`;
  a.click();
  URL.revokeObjectURL(url);
  showToast('エクスポートしました');
}
function importData(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (event) => {
    try {
      const data = JSON.parse(event.target.result);
      if (data.entries && data.categories) {
        state.entries = data.entries;
        state.categories = data.categories;
        state.tabNames = data.tabNames || { company: '会社', personal: '家計簿' };
        state.theme = data.theme || 'pink';
        state.savings = data.savings || { company: {}, personal: {} };
        saveData();
        updateTabNames();
        applyTheme(state.theme);
        renderCalendar();
        renderGraph();
        renderSettings();
        updateCategorySelect();
        showToast('インポートしました');
      }
    } catch (err) { showToast('ファイルの読み込みに失敗しました'); }
  };
  reader.readAsText(file);
  e.target.value = '';
}
function formatCurrency(amount, short = false) {
  return amount.toLocaleString() + '円';
}
function applyTheme(themeName) {
  const theme = THEMES[themeName];
  if (!theme) return;
  const root = document.documentElement;
  root.style.setProperty('--accent', theme.accent);
  root.style.setProperty('--accent-hover', theme.accentHover);
  root.style.setProperty('--accent-light', theme.accentLight);
  root.style.setProperty('--accent-subtle', theme.accentSubtle);
  root.style.setProperty('--bg-base', theme.bgBase);
  root.style.setProperty('--bg-muted', theme.bgMuted);
  document.querySelectorAll('.theme-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.theme === themeName);
  });
}
function showToast(message) {
  let toast = document.querySelector('.toast');
  if (!toast) { toast = document.createElement('div'); toast.className = 'toast'; document.body.appendChild(toast); }
  toast.textContent = message;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 2000);
}
function initReportYears() {
  const select = document.getElementById('report-year');
  const currentYear = new Date().getFullYear();
  select.innerHTML = '';
  for (let y = currentYear; y >= currentYear - 5; y--) {
    const opt = document.createElement('option');
    opt.value = y;
    opt.textContent = y + '年';
    select.appendChild(opt);
  }
  updateReportTabSelect();
}
function updateReportTabSelect() {
  const select = document.getElementById('report-tab');
  select.innerHTML = `
    <option value="company">${state.tabNames.company}のみ</option>
    <option value="personal">${state.tabNames.personal}のみ</option>
    <option value="both">両方</option>
  `;
}
function generateReport() {
  const year = parseInt(document.getElementById('report-year').value);
  const tabChoice = document.getElementById('report-tab').value;
  
  let report = `【${year}年 確定申告用 収支レポート】\n`;
  report += `作成日: ${new Date().toLocaleDateString('ja-JP')}\n`;
  report += `\n${'='.repeat(40)}\n`;
  
  // 会社タブの出力
  if (tabChoice === 'company' || tabChoice === 'both') {
    const companyEntries = state.entries.company.filter(e => new Date(e.date).getFullYear() === year);
    const companyIncome = companyEntries.filter(e => e.type === 'income');
    const companyExpense = companyEntries.filter(e => e.type === 'expense');
    
    report += `\n■ ${state.tabNames.company}\n`;
    report += `-`.repeat(40) + `\n`;
    
    report += `\n【売上・収入】\n`;
    const incomeByCategory = {};
    companyIncome.forEach(e => {
      if (!incomeByCategory[e.category]) incomeByCategory[e.category] = 0;
      incomeByCategory[e.category] += e.amount;
    });
    let totalIncome = 0;
    Object.entries(incomeByCategory).sort((a,b) => b[1] - a[1]).forEach(([cat, amt]) => {
      report += `  ・${cat}: ¥${amt.toLocaleString()}\n`;
      totalIncome += amt;
    });
    report += `  ────────────────\n`;
    report += `  売上合計: ¥${totalIncome.toLocaleString()}\n`;
    
    report += `\n【経費】\n`;
    const expenseByCategory = {};
    companyExpense.forEach(e => {
      if (!expenseByCategory[e.category]) expenseByCategory[e.category] = 0;
      expenseByCategory[e.category] += e.amount;
    });
    let totalExpense = 0;
    Object.entries(expenseByCategory).sort((a,b) => b[1] - a[1]).forEach(([cat, amt]) => {
      report += `  ・${cat}: ¥${amt.toLocaleString()}\n`;
      totalExpense += amt;
    });
    report += `  ────────────────\n`;
    report += `  経費合計: ¥${totalExpense.toLocaleString()}\n`;
    
    const profit = totalIncome - totalExpense;
    report += `\n【所得】\n`;
    report += `  売上 ¥${totalIncome.toLocaleString()} − 経費 ¥${totalExpense.toLocaleString()}\n`;
    report += `  ＝ ¥${profit.toLocaleString()}\n`;
    
    // 月別推移
    report += `\n【月別売上推移】\n`;
    for (let m = 1; m <= 12; m++) {
      const monthIncome = companyIncome.filter(e => new Date(e.date).getMonth() + 1 === m).reduce((s, e) => s + e.amount, 0);
      if (monthIncome > 0) {
        report += `  ${m}月: ¥${monthIncome.toLocaleString()}\n`;
      }
    }
  }
  
  // 個人タブの出力
  if (tabChoice === 'personal' || tabChoice === 'both') {
    if (tabChoice === 'both') {
      report += `\n${'='.repeat(40)}\n`;
    }
    
    const personalEntries = state.entries.personal.filter(e => new Date(e.date).getFullYear() === year);
    const personalIncome = personalEntries.filter(e => e.type === 'income');
    const personalExpense = personalEntries.filter(e => e.type === 'expense');
    
    report += `\n■ ${state.tabNames.personal}\n`;
    report += `-`.repeat(40) + `\n`;
    
    report += `\n【収入】\n`;
    const pIncomeByCategory = {};
    personalIncome.forEach(e => {
      if (!pIncomeByCategory[e.category]) pIncomeByCategory[e.category] = 0;
      pIncomeByCategory[e.category] += e.amount;
    });
    let pTotalIncome = 0;
    Object.entries(pIncomeByCategory).sort((a,b) => b[1] - a[1]).forEach(([cat, amt]) => {
      report += `  ・${cat}: ¥${amt.toLocaleString()}\n`;
      pTotalIncome += amt;
    });
    report += `  ────────────────\n`;
    report += `  収入合計: ¥${pTotalIncome.toLocaleString()}\n`;
    
    report += `\n【支出】\n`;
    const pExpenseByCategory = {};
    personalExpense.forEach(e => {
      if (!pExpenseByCategory[e.category]) pExpenseByCategory[e.category] = 0;
      pExpenseByCategory[e.category] += e.amount;
    });
    let pTotalExpense = 0;
    Object.entries(pExpenseByCategory).sort((a,b) => b[1] - a[1]).forEach(([cat, amt]) => {
      report += `  ・${cat}: ¥${amt.toLocaleString()}\n`;
      pTotalExpense += amt;
    });
    report += `  ────────────────\n`;
    report += `  支出合計: ¥${pTotalExpense.toLocaleString()}\n`;
    
    report += `\n【収支】\n`;
    report += `  ＝ ¥${(pTotalIncome - pTotalExpense).toLocaleString()}\n`;
    
    // 月別推移
    report += `\n【月別収入推移】\n`;
    for (let m = 1; m <= 12; m++) {
      const monthIncome = personalIncome.filter(e => new Date(e.date).getMonth() + 1 === m).reduce((s, e) => s + e.amount, 0);
      if (monthIncome > 0) {
        report += `  ${m}月: ¥${monthIncome.toLocaleString()}\n`;
      }
    }
  }
  
  report += `\n${'='.repeat(40)}\n`;
  report += `\n※このレポートをClaudeに貼り付けて\n  確定申告の相談ができます！\n`;
  
  document.getElementById('report-text').value = report;
  document.getElementById('report-modal').classList.add('show');
}
function copyReport() {
  const text = document.getElementById('report-text').value;
  navigator.clipboard.writeText(text).then(() => {
    showToast('コピーしました！');
  });
}
document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
